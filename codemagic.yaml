workflows:
  ios-testflight:
    name: iOS TestFlight Build
    environment:
      vars:
        XCODE_WORKSPACE: "arkitevideo.xcworkspace"
        XCODE_SCHEME: "arkitevideo"
        BUNDLE_ID: "com.hamid.arkit.new"

        APP_STORE_CONNECT_ISSUER_ID: !encrypted |-
          eyJ2IjogMSwgImRhdGEiOiAiNUY3RTY0MEMtRTRBNy00RTMyLUIzNjQtNjMxMzg1ODE2Mjc1In0=
        
        APP_STORE_CONNECT_KEY_IDENTIFIER: !encrypted |-
          eyJ2IjogMSwgImRhdGEiOiAiNk43Vjg2UUxWMzEifQ==
        
        APP_STORE_CONNECT_PRIVATE_KEY: !encrypted |-
          eyJ2IjogMSwgImRhdGEiOiAiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUdUQWdFQU1CTUdCeXFLU00
          0OUFnRUdDQ3FHU000OUF3RUhCSGt3ZHdJQkFRUWdWVHJLZ1NQQ0l3LzJ4Snp0XG5CQmVCNDExNzdDRFVueXFTMWpaTXVKS
          W5JTHZTZ0NnWUlLb1pJemowREFRaGVSQU5DQUFUUkxueEgrM3ZqaXRwU1xuQ0psWXRLUFV1MGRvVnNMUnhJUG1tVlZjSlV
          FVFBGWVR1TDA5SlE1YnZ4UmpuOVZSa01kV1d5SWM0L2J1MThVXG5RVkdycHJ1K1xuLS0tLS1FTkQgUFJJVkFURSBLRVktL
          S0tLQ==

      xcode: latest

    scripts:
      - name: Set up keychain and signing
        script: |
          keychain initialize
          app-store-connect fetch-signing-files "$BUNDLE_ID" --type IOS_APP_STORE
          keychain add-certificates

      - name: Build .ipa
        script: |
          xcode-project build-ipa \
            --workspace "$XCODE_WORKSPACE" \
            --scheme "$XCODE_SCHEME"

    artifacts:
      - build/ios/ipa/*.ipa

    publishing:
      app_store_connect:
        api_key:
          issuer_id: $APP_STORE_CONNECT_ISSUER_ID
          key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
          private_key: $APP_STORE_CONNECT_PRIVATE_KEY
